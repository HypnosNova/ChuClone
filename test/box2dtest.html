<!DOCTYPE HTML>
<html lang="en">
<head>
    <title>three.js webgl - interactive cubes</title>
    <meta charset="utf-8">
    <style type="text/css">
        body {
            font-family: Monospace;
            background-color: #111111;
            margin: 0px;
            overflow: hidden;
        }
    </style>


    <script type="text/javascript" src="three.js/build/Three.js"></script>

    <script type="text/javascript" src="three.js/examples/js/RequestAnimationFrame.js"></script>
    <script type="text/javascript" src="three.js/examples/js/Stats.js"></script>
    <script type="text/javascript" src="lib/Box2D.js"></script>
    <script type="text/javascript" src="../js/ChuClone/namespace.js"></script>
    <script type="text/javascript" src="../js/ChuClone/Constants.js"></script>
    <script type="text/javascript" src="../js/ChuClone/physics/WorldController.js"></script>
    <script type="text/javascript" src="../js/ChuClone/GameView.js"></script>
    <script type="text/javascript" src="../js/ChuClone/GameEntity.js"></script>
    <script type="text/javascript" src="../js/ChuClone/ChuCloneGame.js"></script>
    <script type="text/javascript">
        //            var game = new ChuClone.ChuCloneGame();
        var world;

        var lastBody;
        function init() {
            var b2Vec2 = Box2D.Common.Math.b2Vec2,
			b2AABB = Box2D.Collision.b2AABB
                    ,    b2BodyDef = Box2D.Dynamics.b2BodyDef
                    ,    b2Body = Box2D.Dynamics.b2Body
                    ,    b2FixtureDef = Box2D.Dynamics.b2FixtureDef
                    ,    b2Fixture = Box2D.Dynamics.b2Fixture
                    ,    b2World = Box2D.Dynamics.b2World
                    ,    b2MassData = Box2D.Collision.Shapes.b2MassData
                    ,    b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
                    ,    b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
                    ,    b2DebugDraw = Box2D.Dynamics.b2DebugDraw
                    ;

            world = new b2World(
                    new b2Vec2(0, 10*30)    //gravity
                    , true                 //allow sleep
            );

            var fixDef = new b2FixtureDef;
            fixDef.density = 1.0;
            fixDef.friction = 0.5;
            fixDef.restitution = 0.2;

            var bodyDef = new b2BodyDef;

            //create ground
            bodyDef.type = b2Body.b2_staticBody;
            bodyDef.position.x = 9*30;
            bodyDef.position.y = 13*30;
            fixDef.shape = new b2PolygonShape;
            fixDef.shape.SetAsBox(10*30, 0.5*30);
            world.CreateBody(bodyDef).CreateFixture(fixDef);

            //create some objects
            bodyDef.type = b2Body.b2_dynamicBody;
            for (var i = 0; i < 1; ++i) {
                if (Math.random() > -0.5) {
                    fixDef.shape = new b2PolygonShape;
                    fixDef.shape.SetAsBox(
                            0.5 *30//half width
                            , 0.5 *30//half height
                    );
                } else {
                    fixDef.shape = new b2CircleShape(
                            Math.random() + 0.1 //radius
                    );
                }
                bodyDef.position.x = 1;
                bodyDef.position.y = 11.5;
                lastBody = world.CreateBody(bodyDef);
                lastBody.CreateFixture(fixDef);
            }


            //setup debug draw
            var debugDraw = new b2DebugDraw();
            debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
            debugDraw.SetDrawScale(1);
            debugDraw.SetFillAlpha(0.3);
            debugDraw.SetLineThickness(1.0);
            debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
            world.SetDebugDraw(debugDraw);

            window.setInterval(update, 1000 / 60);

			function getBodyAtMouse() {
				console.log("YO", mouseX)
				mousePVec = new b2Vec2(mouseX, mouseY);

				var aabb = new b2AABB();
				aabb.lowerBound.Set(mouseX - 0.001, mouseY - 0.001);
				aabb.upperBound.Set(mouseX + 0.001, mouseY + 0.001);

				// Query the world for overlapping shapes.

				selectedBody = null;
				world.QueryAABB(getBodyCB, aabb);
				return selectedBody;
         }

         function getBodyCB(fixture) {
            if(fixture.GetBody().GetType() != b2Body.b2_staticBody) {
               if(fixture.GetShape().TestPoint(fixture.GetBody().GetTransform(), mousePVec)) {
                  selectedBody = fixture.GetBody();
                  return false;
               }
            }
            return true;
         }

		window.addEventListener("mousedown", function(e){
			mouseX = e.clientX/30;
			mouseY = e.clientY/30;

			getBodyAtMouse();
		}, true);
        }

        function update() {

            lastBody.m_angularVelocity = Math.PI/2;
            if(Math.random() < 0.1)
            lastBody.ApplyImpulse(new Box2D.Common.Math.b2Vec2(0.5,0), lastBody.GetPosition() )
            world.Step(
                    1 / 60   //frame-rate
                    , 10       //velocity iterations
                    , 10       //position iterations
            );

            world.DrawDebugData();
            world.ClearForces();
        }

        window.addEventListener("DOMContentLoaded", init, true);
    </script>

    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-1249241-1']);
        _gaq.push(['_trackPageview']);

        (function() {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>

</head>
<body>
<canvas id="canvas" width="600" height="400"></canvas>
</body>
</html>
